# ── Stage 1: build rs1090 ────────────────────────────────────────────
FROM rust:1-slim-trixie AS builder

RUN apt-get update && apt-get install -y --no-install-recommends \
    pkg-config \
    ca-certificates \
    git \
    && rm -rf /var/lib/apt/lists/*

RUN git clone --depth 1 https://github.com/fede2cr/rs1090.git /src/rs1090

WORKDIR /src/rs1090
RUN cargo build --release && \
    strip target/release/rs1090

# ── Stage 2: runtime ────────────────────────────────────────────────
FROM debian:trixie-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    avahi-daemon \
    avahi-utils \
    dbus \
    tini \
    bash \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /src/rs1090/target/release/rs1090 /usr/local/bin/rs1090

# Allow avahi to run inside a container
RUN sed -i 's/^rlimit-nproc=.*/#&/' /etc/avahi/avahi-daemon.conf

RUN mkdir -p /run/readsb /var/lib/co2tracker

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["tini", "--", "/entrypoint.sh"]
