FROM debian:trixie-slim AS builder

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    ca-certificates \
    git \
    librtlsdr-dev \
    libncurses-dev \
    libzstd-dev \
    pkg-config \
    zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

RUN git clone --depth 1 https://github.com/wiedehopf/readsb.git /src/readsb

WORKDIR /src/readsb
RUN make RTLSDR=yes OPTIMIZE="-O2"

# --- Runtime stage ---
FROM debian:trixie-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    librtlsdr0 \
    libncurses6 \
    libzstd1 \
    tini \
    && rm -rf /var/lib/apt/lists/*

COPY --from=builder /src/readsb/readsb /usr/local/bin/readsb

RUN mkdir -p /run/readsb

EXPOSE 30002 30003 30005

ENTRYPOINT ["tini", "--", "/usr/local/bin/readsb"]
CMD [ \
    "--metric", \
    "--net", \
    "--device-type", "rtlsdr", \
    "--net-connector", "0.0.0.0,30003,raw_out", \
    "--net-bo-port", "30005", \
    "--net-ri-port", "30001", \
    "--net-ro-port", "30002", \
    "--net-sbs-port", "30003", \
    "--write-json", "/run/readsb", \
    "--write-json-every", "1", \
    "--json-location-accuracy", "2" \
]
