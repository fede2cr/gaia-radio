FROM debian:trixie-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    git \
    bash \
    wget \
    lighttpd \
    tini \
    jq \
    mawk \
    media-types \
    && rm -rf /var/lib/apt/lists/*

RUN git clone --depth 1 https://github.com/wiedehopf/tar1090.git /src/tar1090
RUN git clone --depth 1 https://github.com/wiedehopf/tar1090-db.git /src/tar1090-db

# Install tar1090 web files + aircraft database into lighttpd document root
RUN mkdir -p /var/www/html/tar1090 && \
    cp -r /src/tar1090/html/* /var/www/html/tar1090/ && \
    cp -r /src/tar1090-db/db /var/www/html/tar1090/db2 && \
    find /var/www/html/tar1090/db2 -name '*.js' -exec sh -c \
      'for f; do mv "$f" "$f.gz" && gunzip "$f.gz"; done' _ {} + && \
    rm -rf /src/tar1090 /src/tar1090-db

# CO₂ tracker — client-side module + server-side daemon
COPY co2tracker.js /var/www/html/tar1090/co2tracker.js
RUN sed -i 's|</body>|<script src="co2tracker.js"></script>\n</body>|' \
    /var/www/html/tar1090/index.html

COPY co2daemon.sh /co2daemon.sh
RUN chmod +x /co2daemon.sh
RUN mkdir -p /var/lib/co2tracker

# Create directories for data and config
RUN mkdir -p /run/readsb /etc/lighttpd/conf-enabled

# Lighttpd configuration for tar1090
RUN cat <<'EOF' > /etc/lighttpd/conf-enabled/tar1090.conf
server.modules += ("mod_setenv", "mod_alias", "mod_redirect")

alias.url += (
    "/data/" => "/run/readsb/",
    "/tar1090/" => "/var/www/html/tar1090/",
    "/" => "/var/www/html/tar1090/"
)

$HTTP["url"] =~ "^/data/.*\.json$" {
    setenv.add-response-header = (
        "Access-Control-Allow-Origin" => "*",
        "Cache-Control" => "no-cache, no-store, must-revalidate"
    )
}
EOF

# Update lighttpd to listen on port 8080
RUN sed -i 's/server.port\s*=.*/server.port = 8080/' /etc/lighttpd/lighttpd.conf || \
    echo 'server.port = 8080' >> /etc/lighttpd/lighttpd.conf

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 8080

ENTRYPOINT ["tini", "--", "/entrypoint.sh"]
